<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #f3f4f6 50%, #e5e7eb 100%);
        }
        .purple-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 25%, #c084fc 50%, #ddd6fe 75%, #f3f4f6 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.1), 0 4px 6px -2px rgba(139, 92, 246, 0.05);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .nav-active {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .nav-inactive {
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
        }
        .nav-inactive:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #8b5cf6;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="purple-gradient rounded-2xl p-8 card-shadow">
                <h1 class="text-4xl font-bold text-white mb-2">üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
                <p class="text-purple-100 mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                <div id="connectionStatus" class="flex items-center justify-center space-x-2 text-purple-100">
                    <span id="statusIcon">üîó</span>
                    <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center mb-8">
            <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-2 card-shadow flex items-center space-x-2">
                <button id="transactionTab" class="nav-active px-8 py-4 rounded-xl font-medium transition-all transform hover:scale-105">
                    üìä ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                </button>
                <button id="loanTab" class="nav-inactive px-8 py-4 rounded-xl font-medium transition-all transform hover:scale-105">
                    üí≥ ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                </button>
                <div class="border-l border-gray-300 h-8 mx-2"></div>
                <button id="refreshDataBtn" onclick="refreshDataFromSheets()" class="px-6 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-all transform hover:scale-105 flex items-center space-x-2" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets">
                    <span id="refreshIcon">üîÑ</span>
                    <span class="hidden md:inline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                </button>
            </div>
        </div>

        <!-- Transaction Section -->
        <div id="transactionSection" class="space-y-6">
            <!-- Balance Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-emerald-600 mb-2" id="totalIncome">0</div>
                    <div class="text-sm text-emerald-700 font-medium">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
                </div>
                <div class="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-rose-600 mb-2" id="totalExpense">0</div>
                    <div class="text-sm text-rose-700 font-medium">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="currentBalance">0</div>
                    <div class="text-sm text-blue-700 font-medium">üíé ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                </div>
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-amber-600 mb-2" id="totalBorrowed">0</div>
                    <div class="text-sm text-amber-700 font-medium">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏£‡∏ß‡∏°</div>
                </div>
            </div>

            <!-- Add Transaction Form -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="mr-3">‚ú®</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                </h2>
                <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="transactionDate" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="transactionItem" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="transactionType" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" required>
                            <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                            <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                            <option value="loan">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <div class="flex space-x-2">
                            <select id="transactionCategory" class="flex-1 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" required>
                                <!-- Categories will be populated by JavaScript -->
                            </select>
                            <button type="button" onclick="showAddCategoryModal()" class="px-4 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all transform hover:scale-105" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
                                ‚ûï
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="transactionAmount" step="0.01" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" id="transactionNote" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                    </div>
                    <div class="lg:col-span-3">
                        <button type="submit" id="transactionSubmitBtn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                            <span id="transactionSubmitText">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            <span id="transactionLoadingText" class="hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Filters -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="filterStartDate" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="filterEndDate" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select id="filterCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="applyFilters()" class="px-6 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-all transform hover:scale-105">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <button onclick="clearFilters()" class="px-6 py-2 bg-gray-400 text-white rounded-xl hover:bg-gray-500 transition-all transform hover:scale-105">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                </div>
            </div>

            <!-- Transaction List -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="mr-3">üìã</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </h2>
                <div id="transactionList" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìä</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Section -->
        <div id="loanSection" class="hidden space-y-6">
            <!-- Loan Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-red-600 mb-2" id="totalDebt">0</div>
                    <div class="text-sm text-red-700 font-medium">üí≥ ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                </div>
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-orange-600 mb-2" id="activeLoanCount">0</div>
                    <div class="text-sm text-orange-700 font-medium">üìä ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6 text-center card-shadow">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="totalPaid">0</div>
                    <div class="text-sm text-green-700 font-medium">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
            </div>

            <!-- Add Loan Transaction Form -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="mr-3">üí≥</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                </h2>
                <form id="loanForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="loanDate" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="loanName" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô, ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="loanTransactionType" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" required>
                            <option value="borrow">üè¶ ‡∏Å‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°</option>
                            <option value="repay">üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="loanAmount" step="0.01" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white/90 transition-all" placeholder="0.00" required>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="loanSubmitBtn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                            <span id="loanSubmitText">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</span>
                            <span id="loanLoadingText" class="hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loan List -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="mr-3">üìä</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                </h2>
                <div id="loanList" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üí≥</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h2>
                <button onclick="closeAddCategoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <form id="addCategoryForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="newCategoryType" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                        <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <input type="text" id="newCategoryName" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" required>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeAddCategoryModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <button onclick="closeEditTransactionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <form id="editTransactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="editTransactionDate" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="editTransactionItem" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="editTransactionType" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                        <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="loan">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="editTransactionCategory" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="editTransactionAmount" step="0.01" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <input type="text" id="editTransactionNote" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent bg-white transition-all">
                </div>
                <div class="md:col-span-2 flex space-x-4">
                    <button type="button" onclick="closeEditTransactionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-4 px-6 rounded-xl transition-all">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLDL8-6ErwYcq-7a55VYZP1ctMl-G_9YqxUKkDnIK3fgBqONfNBzjvg7oySut499c2/exec'; 

        // --- GLOBAL STATE ---
        let transactions = [];
        let loanTransactions = [];
        let categories = {
            income: ['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'],
            expense: ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢', '‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ', '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ']
        };
        let allTransactions = []; // For filtering

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => initializeApp());

        async function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('loanDate').value = today;
            setupEventListeners();
            updateCategoryOptions();
            await refreshDataFromSheets();
        }

        async function refreshDataFromSheets() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            refreshBtn.disabled = true;
            refreshIcon.classList.add('animate-spin');
            
            try {
                const [transData, loansData] = await Promise.all([
                    loadFromGoogleSheets('Transactions'),
                    loadFromGoogleSheets('Loans')
                ]);

                transactions = transData.map(mapSheetTransactionToApp).filter(Boolean);
                loanTransactions = loansData.map(mapSheetLoanToApp).filter(Boolean);
                allTransactions = [...transactions]; // Store a copy for filtering
                
                updateAllDisplays();
                updateConnectionStatus(true, `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ${new Date().toLocaleTimeString('th-TH')}`);
                showNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                updateConnectionStatus(false, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ');
            } finally {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('animate-spin');
            }
        }

        function setupEventListeners() {
            document.getElementById('transactionTab').addEventListener('click', () => switchTab('transaction'));
            document.getElementById('loanTab').addEventListener('click', () => switchTab('loan'));
            
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            document.getElementById('loanForm').addEventListener('submit', handleLoanSubmit);
            document.getElementById('addCategoryForm').addEventListener('submit', handleAddCategory);
            document.getElementById('editTransactionForm').addEventListener('submit', handleEditTransactionSubmit);
            
            document.getElementById('transactionType').addEventListener('change', updateCategoryOptions);
            document.getElementById('editTransactionType').addEventListener('change', updateEditCategoryOptions);

            document.getElementById('transactionList').addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                const deleteButton = e.target.closest('.delete-btn');
                if (editButton) {
                    openEditModal(editButton.dataset.id);
                }
                if (deleteButton) {
                    deleteTransaction(deleteButton.dataset.id);
                }
            });
        }

        function switchTab(tab) {
            ['transaction', 'loan'].forEach(t => {
                document.getElementById(`${t}Tab`).classList.replace('nav-active', 'nav-inactive');
                document.getElementById(`${t}Section`).classList.add('hidden');
            });
            document.getElementById(`${tab}Tab`).classList.replace('nav-inactive', 'nav-active');
            document.getElementById(`${tab}Section`).classList.remove('hidden');
        }
        
        function updateAllDisplays() {
            updateTransactionSummary();
            updateLoanSummary();
            displayTransactions(transactions);
            displayLoans();
        }

        // --- API & DATA HANDLING ---
        async function apiCall(action, payload = {}) {
            const body = { action, ...payload };
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(body)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            setLoadingState('transactionSubmitBtn', true);

            const formData = {
                id: Date.now().toString(),
                date: document.getElementById('transactionDate').value,
                item: document.getElementById('transactionItem').value,
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                note: document.getElementById('transactionNote').value || '-'
            };

            allTransactions.unshift(formData);
            transactions = [...allTransactions];
            updateAllDisplays();
            e.target.reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];

            try {
                await apiCall('addTransaction', formData);
                showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error adding transaction:', error);
                showNotification('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            } finally {
                setLoadingState('transactionSubmitBtn', false);
            }
        }
        
        async function handleEditTransactionSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editTransactionId').value;
            const updatedData = {
                id: id,
                date: document.getElementById('editTransactionDate').value,
                item: document.getElementById('editTransactionItem').value,
                type: document.getElementById('editTransactionType').value,
                category: document.getElementById('editTransactionCategory').value,
                amount: parseFloat(document.getElementById('editTransactionAmount').value),
                note: document.getElementById('editTransactionNote').value || '-'
            };

            const index = allTransactions.findIndex(t => t.id == id);
            if (index !== -1) allTransactions[index] = updatedData;
            transactions = [...allTransactions];
            updateAllDisplays();
            closeEditTransactionModal();

            try {
                await apiCall('updateTransaction', updatedData);
                showNotification('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error updating transaction:', error);
                showNotification('‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            const originalTransactions = [...allTransactions];
            allTransactions = allTransactions.filter(t => t.id != id);
            transactions = [...allTransactions];
            updateAllDisplays();

            try {
                await apiCall('deleteTransaction', { id });
                showNotification('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'info');
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                allTransactions = originalTransactions; // Revert
                transactions = [...allTransactions];
                updateAllDisplays();
            }
        }

        async function handleLoanSubmit(e) {
            e.preventDefault();
            setLoadingState('loanSubmitBtn', true);

            const loanData = {
                id: Date.now().toString(),
                date: document.getElementById('loanDate').value,
                loanName: document.getElementById('loanName').value,
                type: document.getElementById('loanTransactionType').value,
                amount: parseFloat(document.getElementById('loanAmount').value),
            };

            loanTransactions.push(loanData);
            updateAllDisplays();
            e.target.reset();
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];

            try {
                await apiCall('addLoan', loanData);
                showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error adding loan:', error);
                showNotification('‚ö†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            } finally {
                setLoadingState('loanSubmitBtn', false);
            }
        }

        async function loadFromGoogleSheets(sheetName) {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=get${sheetName}&t=${Date.now()}`, {
                method: 'GET',
                mode: 'cors'
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error || `Failed to load ${sheetName}`);
            return result.data || [];
        }

        // --- MAPPING FUNCTIONS ---
        function mapSheetTransactionToApp(row) {
            if (!row.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà || !row.id) return null;
            return {
                id: row.id,
                date: new Date(row.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà).toISOString().split('T')[0],
                item: row.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,
                type: mapSheetTypeToAppType(row.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó),
                category: row.‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà,
                amount: parseFloat(row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) || 0,
                note: row.‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ || ''
            };
        }

        function mapSheetLoanToApp(row) {
            if (!row.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà || !row.id) return null;
            return {
                id: row.id,
                date: new Date(row.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà).toISOString().split('T')[0],
                loanName: row.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,
                type: mapSheetLoanTypeToAppType(row.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó),
                amount: parseFloat(row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) || 0
            };
        }

        function mapSheetTypeToAppType(sheetType) {
            const map = { '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö': 'income', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢': 'expense', '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ': 'loan' };
            return map[sheetType] || 'expense';
        }

        function mapSheetLoanTypeToAppType(sheetType) {
            const map = { '‡∏Å‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°': 'borrow', '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô': 'repay' };
            return map[sheetType] || 'borrow';
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateTransactionSummary() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const borrowed = transactions.filter(t => t.type === 'loan').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;
            
            document.getElementById('totalIncome').textContent = income.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('totalExpense').textContent = expense.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('currentBalance').textContent = balance.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('totalBorrowed').textContent = borrowed.toLocaleString('th-TH', {minimumFractionDigits: 2});
        }

        function displayTransactions(trans) {
            const container = document.getElementById('transactionList');
            if (trans.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">üìù</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>`;
                return;
            }
            container.innerHTML = trans.map(t => {
                const typeIcon = { 'income': 'üí∞', 'expense': 'üí∏', 'loan': 'üè¶' };
                const typeColor = { 'income': 'text-emerald-600', 'expense': 'text-rose-600', 'loan': 'text-amber-600' };
                const typeText = { 'income': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'expense': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', 'loan': '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ' };
                return `
                    <div class="transaction-item flex justify-between items-center p-5 bg-white/70 backdrop-blur-sm border border-gray-200 rounded-xl hover:bg-white/90 transition-all">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-2xl">${typeIcon[t.type]}</span>
                                <div>
                                    <span class="font-semibold text-gray-700 text-lg">${t.item}</span>
                                    <span class="ml-2 px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">${typeText[t.type]}</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 ml-10">
                                <span>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${t.category}</span> | <span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${t.note}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <div class="text-right">
                                <div class="font-bold text-xl ${typeColor[t.type]}">
                                    ${t.type === 'expense' ? '-' : '+'}${t.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ø
                                </div>
                                <div class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString('th-TH')}</div>
                            </div>
                            <button class="edit-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full transition-all" data-id="${t.id}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button class="delete-btn p-2 text-red-600 hover:bg-red-100 rounded-full transition-all" data-id="${t.id}" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function displayLoans() {
            const container = document.getElementById('loanList');
            const loanGroups = getLoanBalances(true); // Get detailed groups
            
            if (Object.keys(loanGroups).length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">üí≥</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p></div>`;
                return;
            }

            container.innerHTML = Object.keys(loanGroups).map(loanName => {
                const group = loanGroups[loanName];
                const balance = group.balance;
                if (balance <= 0) return ''; // Don't show paid off loans here
                return `
                    <div class="bg-white/70 backdrop-blur-sm border border-gray-200 rounded-xl p-6 card-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-700">üí≥ ${loanName}</h3>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-red-600">${balance.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ø</div>
                                <div class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${group.transactions.slice(0, 5).map(t => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-lg">${t.type === 'borrow' ? 'üè¶' : 'üí∞'}</span>
                                        <div>
                                            <div class="font-medium text-gray-700">${t.type === 'borrow' ? '‡∏Å‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô'}</div>
                                            <div class="text-sm text-gray-600">${new Date(t.date).toLocaleDateString('th-TH')}</div>
                                        </div>
                                    </div>
                                    <div class="font-bold ${t.type === 'borrow' ? 'text-red-600' : 'text-green-600'}">
                                        ${t.type === 'borrow' ? '+' : '-'}${t.amount.toLocaleString('th-TH')} ‡∏ø
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }).join('');
        }

        function updateLoanSummary() {
            const loanBalances = getLoanBalances();
            const totalDebt = Object.values(loanBalances).reduce((sum, balance) => sum + Math.max(0, balance), 0);
            const activeLoanCount = Object.values(loanBalances).filter(balance => balance > 0).length;
            const totalPaid = loanTransactions.filter(t => t.type === 'repay').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalDebt').textContent = totalDebt.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('activeLoanCount').textContent = activeLoanCount;
            document.getElementById('totalPaid').textContent = totalPaid.toLocaleString('th-TH', {minimumFractionDigits: 2});
        }
        
        function getLoanBalances(detailed = false) {
            const loanGroups = {};
            loanTransactions.forEach(t => {
                if (!loanGroups[t.loanName]) {
                    loanGroups[t.loanName] = { balance: 0, transactions: [] };
                }
                loanGroups[t.loanName].transactions.push(t);
            });

            Object.keys(loanGroups).forEach(name => {
                let balance = 0;
                loanGroups[name].transactions.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                    balance += (t.type === 'borrow' ? t.amount : -t.amount);
                });
                loanGroups[name].balance = balance;
            });
            
            if (detailed) return loanGroups;
            
            const balances = {};
            Object.keys(loanGroups).forEach(name => {
                balances[name] = loanGroups[name].balance;
            });
            return balances;
        }

        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            
            let filtered = allTransactions.filter(t => {
                if (startDate && t.date < startDate) return false;
                if (endDate && t.date > endDate) return false;
                if (category && t.category !== category) return false;
                return true;
            });
            transactions = filtered;
            displayTransactions(transactions);
        }

        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterCategory').value = '';
            transactions = [...allTransactions];
            displayTransactions(transactions);
        }
        
        // --- MODALS & CATEGORIES ---
        function showAddCategoryModal() { document.getElementById('addCategoryModal').classList.remove('hidden'); }
        function closeAddCategoryModal() { document.getElementById('addCategoryModal').classList.add('hidden'); }
        function openEditModal(id) {
            const t = allTransactions.find(t => t.id == id);
            if (!t) return;
            document.getElementById('editTransactionId').value = t.id;
            document.getElementById('editTransactionDate').value = t.date;
            document.getElementById('editTransactionItem').value = t.item;
            document.getElementById('editTransactionType').value = t.type;
            updateEditCategoryOptions();
            document.getElementById('editTransactionCategory').value = t.category;
            document.getElementById('editTransactionAmount').value = t.amount;
            document.getElementById('editTransactionNote').value = t.note;
            document.getElementById('editTransactionModal').classList.remove('hidden');
        }
        function closeEditTransactionModal() { document.getElementById('editTransactionModal').classList.add('hidden'); }
        function handleAddCategory(e) {
            e.preventDefault();
            const type = document.getElementById('newCategoryType').value;
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name || categories[type].includes(name)) {
                showNotification('‚ùå ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', 'error');
                return;
            }
            categories[type].push(name);
            updateCategoryOptions();
            closeAddCategoryModal();
            showNotification('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }
        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '';
            const list = type === 'loan' ? ['‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ'] : categories[type];
            list.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            updateFilterCategoryOptions();
        }
        function updateEditCategoryOptions() {
            const type = document.getElementById('editTransactionType').value;
            const select = document.getElementById('editTransactionCategory');
            select.innerHTML = '';
            const list = type === 'loan' ? ['‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ'] : categories[type];
            list.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        function updateFilterCategoryOptions() {
            const select = document.getElementById('filterCategory');
            select.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            [...new Set([...categories.income, ...categories.expense, '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ'])].forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        // --- UTILITY FUNCTIONS ---
        function updateConnectionStatus(connected, message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            if (connected) {
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = message;
                statusText.className = 'text-green-200';
            } else {
                statusIcon.textContent = '‚ùå';
                statusText.textContent = message;
                statusText.className = 'text-red-200';
            }
        }

        function setLoadingState(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            const textSpan = document.getElementById(buttonId.replace('Btn', 'Text'));
            const loadingSpan = document.getElementById(buttonId.replace('Btn', 'LoadingText'));
            button.disabled = isLoading;
            button.classList.toggle('loading', isLoading);
            if (textSpan) textSpan.classList.toggle('hidden', isLoading);
            if (loadingSpan) loadingSpan.classList.toggle('hidden', !isLoading);
        }
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const styles = { success: 'bg-emerald-500', error: 'bg-rose-500', warning: 'bg-amber-500', info: 'bg-blue-500' };
            notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg z-50 text-white transform transition-all duration-300 translate-x-full ${styles[type]}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => document.body.contains(notification) && document.body.removeChild(notification), 300);
            }, 3000);
        }
        function copyGoogleScript() {
            navigator.clipboard.writeText(document.getElementById('googleScriptCode').textContent).then(() => showNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'info'));
        }
    </script>
</body>
</html>
