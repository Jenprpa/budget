<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
        }
        .pearl-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 25%, #f1f5f9 50%, #e2e8f0 75%, #cbd5e1 100%);
        }
        .pearl-shadow {
            box-shadow: 0 10px 25px -5px rgba(148, 163, 184, 0.1), 0 4px 6px -2px rgba(148, 163, 184, 0.05);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .delete-btn, .edit-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .transaction-item:hover .delete-btn, .transaction-item:hover .edit-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="pearl-gradient rounded-2xl p-8 pearl-shadow">
                <h1 class="text-4xl font-bold text-slate-700 mb-2">üíé ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
                <p class="text-slate-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                <div class="mt-4 flex flex-col items-center justify-center space-y-2 text-sm text-slate-500">
                    <div class="flex items-center space-x-2">
                        <span>üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets</span>
                        <div id="connectionStatus" class="w-3 h-3 bg-red-400 rounded-full"></div>
                    </div>
                    <div id="setupInstructions" class="text-xs text-center max-w-4xl">
                         <details class="mt-2 text-left cursor-pointer">
                            <summary class="text-blue-600 hover:text-blue-800 font-medium">üìñ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)</summary>
                            <div class="mt-3 p-4 bg-blue-50 rounded-lg text-slate-700 space-y-4">
                                <div class="bg-white p-3 rounded border-l-4 border-purple-500">
                                    <h3 class="font-bold text-purple-700 mb-2">üöÄ Deploy ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)</h3>
                                    <ol class="list-decimal list-inside space-y-1 text-sm">
                                        <li>‡πÄ‡∏õ‡∏¥‡∏î <a href="https://script.google.com/home/projects/create" target="_blank" class="text-blue-600 underline font-medium">Google Apps Script</a> ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</li>
                                        <li>‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ß‡∏≤‡∏á</li>
                                        <li>**‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç `SPREADSHEET_ID` ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏Ç‡∏≠‡∏á Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
                                        <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy" > "New deployment"</li>
                                        <li>‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á "Select type" ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏ü‡∏∑‡∏≠‡∏á ‚öôÔ∏è ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Web app"</li>
                                        <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Who has access" ‡πÄ‡∏õ‡πá‡∏ô **"Anyone"** (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</li>
                                        <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy" ‡πÅ‡∏•‡∏∞ **"Authorize access"** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</li>
                                        <li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å **Web app URL** ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</li>
                                    </ol>
                                </div>
                                <div class="mt-2 bg-gray-900 text-green-400 p-3 rounded text-xs overflow-x-auto">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-yellow-400">üìã Google Apps Script Code</span>
                                        <button onclick="copyGoogleScript()" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                                    </div>
                                    <pre id="googleScriptCode" class="whitespace-pre-wrap">const SPREADSHEET_ID = '1dFqF8Kt95kCLEiFFH-Y16R4Xn6HRSbfYea7W-4jJVks';

function doGet(e){var t=e.parameter.action;try{if("getTransactions"===t)return getTransactions();if("getLoans"===t)return getLoans();return ContentService.createTextOutput(JSON.stringify({success:!1,error:"Invalid action"})).setMimeType(ContentService.MimeType.JSON)}catch(e){return ContentService.createTextOutput(JSON.stringify({success:!1,error:e.toString()})).setMimeType(ContentService.MimeType.JSON)}}
function doPost(e){var t=JSON.parse(e.postData.contents),o=t.action;try{return"addTransaction"===o?addTransaction(t):"updateTransaction"===o?updateTransaction(t):"deleteTransaction"===o?deleteTransaction(t):"addLoan"===o?addLoan(t):"updateLoan"===o?updateLoan(t):"deleteLoan"===o?deleteLoan(t):ContentService.createTextOutput(JSON.stringify({success:!1,error:"Invalid action"})).setMimeType(ContentService.MimeType.JSON)}catch(e){return ContentService.createTextOutput(JSON.stringify({success:!1,error:e.toString()})).setMimeType(ContentService.MimeType.JSON)}}
function getTransactions(){var e=SpreadsheetApp.openById(SPREADSHEET_ID),t=e.getSheetByName("Transactions");t||(t=e.insertSheet("Transactions")).getRange(1,1,1,10).setValues([["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡πÄ‡∏ß‡∏•‡∏≤","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà","‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","id","timestamp"]]);for(var o=t.getDataRange().getValues(),a=[],n=1;n<o.length;n++)a.push({date:o[n][0],time:o[n][1],type:o[n][2],amount:o[n][3],category:o[n][4],payment_method:o[n][5],description:o[n][6],status:o[n][7],id:o[n][8],timestamp:o[n][9]});return ContentService.createTextOutput(JSON.stringify({success:!0,data:a})).setMimeType(ContentService.MimeType.JSON)}
function addTransaction(e){var t=SpreadsheetApp.openById(SPREADSHEET_ID),o=t.getSheetByName("Transactions");o||(o=t.insertSheet("Transactions")).getRange(1,1,1,10).setValues([["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡πÄ‡∏ß‡∏•‡∏≤","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà","‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","id","timestamp"]]);var a=new Date;return o.appendRow([e.date,a.toLocaleTimeString("th-TH"),e.type,e.amount,e.category,e.payment_method,e.description,"active",e.id,e.timestamp]),ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}
function updateTransaction(e){for(var t=SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Transactions").getDataRange().getValues(),o=1;o<t.length;o++)if(t[o][8]==e.id){var a=new Date;SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Transactions").getRange(o+1,1,1,10).setValues([[e.date,a.toLocaleTimeString("th-TH"),e.type,e.amount,e.category,e.payment_method,e.description,"active",e.id,e.timestamp]]);break}return ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}
function deleteTransaction(e){for(var t=SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Transactions").getDataRange().getValues(),o=1;o<t.length;o++)if(t[o][8]==e.id){SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Transactions").deleteRow(o+1);break}return ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}
function getLoans(){var e=SpreadsheetApp.openById(SPREADSHEET_ID),t=e.getSheetByName("Loans");t||(t=e.insertSheet("Loans")).getRange(1,1,1,10).setValues([["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡πÄ‡∏ß‡∏•‡∏≤","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà","‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","id","timestamp"]]);for(var o=t.getDataRange().getValues(),a=[],n=1;n<o.length;n++)a.push({date:o[n][0],time:o[n][1],type:o[n][2],amount:o[n][3],category:o[n][4],payment_method:o[n][5],description:o[n][6],status:o[n][7],id:o[n][8],timestamp:o[n][9]});return ContentService.createTextOutput(JSON.stringify({success:!0,data:a})).setMimeType(ContentService.MimeType.JSON)}
function addLoan(e){var t=SpreadsheetApp.openById(SPREADSHEET_ID),o=t.getSheetByName("Loans");o||(o=t.insertSheet("Loans")).getRange(1,1,1,10).setValues([["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡πÄ‡∏ß‡∏•‡∏≤","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô","‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà","‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞","‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","id","timestamp"]]);var a=new Date;return o.appendRow([e.startDate,a.toLocaleTimeString("th-TH"),e.type,e.amount,e.name,"loan",e.note,"active",e.id,e.timestamp]),ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}
function updateLoan(e){for(var t=SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Loans").getDataRange().getValues(),o=1;o<t.length;o++)if(t[o][8]==e.id){var a=new Date;SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Loans").getRange(o+1,1,1,10).setValues([[e.startDate,a.toLocaleTimeString("th-TH"),e.type,e.amount,e.name,"loan",e.note,"active",e.id,e.timestamp]]);break}return ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}
function deleteLoan(e){for(var t=SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Loans").getDataRange().getValues(),o=1;o<t.length;o++)if(t[o][8]==e.id){SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("Loans").deleteRow(o+1);break}return ContentService.createTextOutput(JSON.stringify({success:!0})).setMimeType(ContentService.MimeType.JSON)}</pre>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="pearl-gradient rounded-xl p-1 pearl-shadow">
                <button id="recordTab" class="px-8 py-4 rounded-lg font-medium transition-all bg-slate-600 text-white shadow-lg">
                    üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button id="calendarTab" class="px-8 py-4 rounded-lg font-medium transition-all text-slate-600 hover:text-slate-800 hover:bg-white/50">
                    üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                </button>
                <button id="loanTab" class="px-8 py-4 rounded-lg font-medium transition-all text-slate-600 hover:text-slate-800 hover:bg-white/50">
                    üí≥ ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>
        </div>

        <!-- Record Section -->
        <div id="recordSection" class="space-y-6">
            <!-- Add Transaction Form -->
            <div class="pearl-gradient rounded-2xl pearl-shadow p-8">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <span class="mr-3">‚ú®</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                </h2>
                <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <select id="type" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all">
                            <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                            <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="amount" step="0.01" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <input type="text" id="category" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                        <select id="paymentMethod" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all">
                            <option value="cash">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="credit_card">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            <option value="transfer">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <input type="text" id="description" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="date" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                            <span id="submitText">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            <span id="loadingText" class="hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Transactions -->
            <div class="pearl-gradient rounded-2xl pearl-shadow p-8">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <span class="mr-3">üìã</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </h2>
                <div id="recentTransactions" class="space-y-4">
                    <div class="text-center py-8 text-slate-500">
                        <div class="text-4xl mb-2">üìä</div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Section -->
        <div id="loanSection" class="hidden space-y-6">
            <!-- Loan Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6 text-center pearl-shadow">
                    <div class="text-3xl font-bold text-orange-600 mb-2" id="totalLoans">0</div>
                    <div class="text-sm text-orange-700 font-medium">üí≥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</div>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-xl p-6 text-center pearl-shadow">
                    <div class="text-3xl font-bold text-red-600 mb-2" id="totalDebt">0</div>
                    <div class="text-sm text-red-700 font-medium">üí∏ ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-6 text-center pearl-shadow">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="monthlyPayment">0</div>
                    <div class="text-sm text-purple-700 font-medium">üìÖ ‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border-2 border-yellow-200 rounded-xl p-6 text-center pearl-shadow">
                    <div class="text-3xl font-bold text-yellow-600 mb-2" id="totalInterest">0</div>
                    <div class="text-sm text-yellow-700 font-medium">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</div>
                </div>
            </div>

            <!-- Add Loan Form -->
            <div class="pearl-gradient rounded-2xl pearl-shadow p-8">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <span class="mr-3">üí≥</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
                </h2>
                <form id="loanForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</label>
                        <select id="loanType" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                            <option value="personal">üè¶ ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
                            <option value="home">üè† ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</option>
                            <option value="car">üöó ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
                            <option value="credit_card">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            <option value="other">üìã ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="loanName" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ABC" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="loanAmount" step="0.01" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label>
                        <input type="number" id="interestRate" step="0.01" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="5.25" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                        <input type="number" id="loanTerm" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="60" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡πà‡∏≠‡∏ô</label>
                        <input type="date" id="loanStartDate" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" id="loanNote" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="loanSubmitBtn" class="w-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                            <span id="loanSubmitText">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</span>
                            <span id="loanLoadingText" class="hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loan List -->
            <div class="pearl-gradient rounded-2xl pearl-shadow p-8">
                <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                    <span class="mr-3">üìã</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                </h2>
                <div id="loanList" class="space-y-4">
                    <div class="text-center py-8 text-slate-500">
                        <div class="text-4xl mb-2">üí≥</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendarSection" class="hidden">
            <div class="pearl-gradient rounded-2xl pearl-shadow p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-semibold text-slate-700 flex items-center">
                        <span class="mr-3">üìÖ</span>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </h2>
                    <div class="flex items-center space-x-4">
                        <button id="prevMonth" class="p-3 hover:bg-white/50 rounded-xl transition-all transform hover:scale-105">
                            ‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                        </button>
                        <span id="currentMonth" class="font-semibold text-lg text-slate-700 px-4"></span>
                        <button id="nextMonth" class="p-3 hover:bg-white/50 rounded-xl transition-all transform hover:scale-105">
                            ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Monthly Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-200 rounded-xl p-6 text-center pearl-shadow">
                        <div class="text-3xl font-bold text-emerald-600 mb-2" id="monthlyIncome">0</div>
                        <div class="text-sm text-emerald-700 font-medium">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-200 rounded-xl p-6 text-center pearl-shadow">
                        <div class="text-3xl font-bold text-rose-600 mb-2" id="monthlyExpense">0</div>
                        <div class="text-sm text-rose-700 font-medium">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6 text-center pearl-shadow">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="monthlyBalance">0</div>
                        <div class="text-sm text-blue-700 font-medium">üíé ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white/50 rounded-xl p-4 backdrop-blur-sm">
                    <div class="grid grid-cols-7 gap-2" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="pearl-gradient rounded-2xl pearl-shadow p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-slate-700">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <button onclick="closeEditModal()" class="text-slate-500 hover:text-slate-700 text-2xl">√ó</button>
            </div>
            <form id="editTransactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <select id="editType" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all">
                        <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="editAmount" step="0.01" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <input type="text" id="editCategory" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                    <select id="editPaymentMethod" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all">
                        <option value="cash">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                        <option value="credit_card">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                        <option value="transfer">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <input type="text" id="editDescription" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="editDate" class="w-full p-4 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-400 focus:border-transparent bg-white/80 backdrop-blur-sm transition-all" required>
                </div>
                <div class="flex items-end space-x-4 md:col-span-2">
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 font-medium py-4 px-6 rounded-xl transition-all">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-medium py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLDL8-6ErwYcq-7a55VYZP1ctMl-G_9YqxUKkDnIK3fgBqONfNBzjvg7oySut499c2/exec'; 

        // --- GLOBAL STATE ---
        let currentDate = new Date();
        let transactions = [];
        let loans = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('loanStartDate').valueAsDate = new Date();
            setupEventListeners();
            await loadAllData();
        }

        function setupEventListeners() {
            document.getElementById('recordTab').addEventListener('click', () => switchTab('record'));
            document.getElementById('calendarTab').addEventListener('click', () => switchTab('calendar'));
            document.getElementById('loanTab').addEventListener('click', () => switchTab('loan'));
            
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            document.getElementById('loanForm').addEventListener('submit', handleLoanSubmit);
            document.getElementById('editTransactionForm').addEventListener('submit', handleEditTransactionSubmit);
            
            document.getElementById('prevMonth').addEventListener('click', () => navigateMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => navigateMonth(1));

            // Event delegation for dynamic buttons
            document.getElementById('recentTransactions').addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const id = e.target.closest('.delete-btn').dataset.id;
                    deleteTransaction(id);
                }
                if (e.target.closest('.edit-btn')) {
                    const id = e.target.closest('.edit-btn').dataset.id;
                    openEditModal(id);
                }
            });
        }
        
        async function loadAllData() {
            await loadTransactions();
            await loadLoans();
            updateCalendar();
            updateLoanSummary();
        }

        // --- UI & TAB MANAGEMENT ---
        function switchTab(tab) {
            ['record', 'calendar', 'loan'].forEach(t => {
                document.getElementById(`${t}Tab`).className = 'px-8 py-4 rounded-lg font-medium transition-all text-slate-600 hover:text-slate-800 hover:bg-white/50';
                document.getElementById(`${t}Section`).classList.add('hidden');
            });
            document.getElementById(`${tab}Tab`).className = 'px-8 py-4 rounded-lg font-medium transition-all bg-slate-600 text-white shadow-lg';
            document.getElementById(`${tab}Section`).classList.remove('hidden');
            if (tab === 'calendar') updateCalendar();
            if (tab === 'loan') updateLoanSummary();
        }

        // --- API & DATA HANDLING ---
        async function apiCall(action, payload = {}) {
            if (!isApiConfigured()) {
                throw new Error("API URL not configured.");
            }
            
            const body = { action, ...payload };
            
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain to avoid preflight
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            setLoadingState(submitBtn, true);

            const formData = {
                id: Date.now().toString(),
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                payment_method: document.getElementById('paymentMethod').value,
                description: document.getElementById('description').value || '-',
                date: document.getElementById('date').value,
                timestamp: new Date().toISOString()
            };

            transactions.unshift(formData);
            displayRecentTransactions();
            updateCalendar();
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();

            try {
                await apiCall('addTransaction', formData);
                showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error adding transaction:', error);
                showNotification('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            } finally {
                setLoadingState(submitBtn, false);
            }
        }
        
        async function handleEditTransactionSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editTransactionId').value;
            const updatedData = {
                id: id,
                type: document.getElementById('editType').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                category: document.getElementById('editCategory').value,
                payment_method: document.getElementById('editPaymentMethod').value,
                description: document.getElementById('editDescription').value || '-',
                date: document.getElementById('editDate').value,
                timestamp: new Date().toISOString()
            };

            const index = transactions.findIndex(t => t.id == id);
            if (index !== -1) {
                transactions[index] = updatedData;
            }
            displayRecentTransactions();
            updateCalendar();
            closeEditModal();

            try {
                await apiCall('updateTransaction', updatedData);
                showNotification('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error updating transaction:', error);
                showNotification('‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
                // Note: You might want to add logic to revert the change if the API call fails.
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            const originalTransactions = [...transactions];
            transactions = transactions.filter(t => t.id != id);
            displayRecentTransactions();
            updateCalendar();

            try {
                await apiCall('deleteTransaction', { id });
                showNotification('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'info');
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                transactions = originalTransactions; // Revert
                displayRecentTransactions();
                updateCalendar();
            }
        }

        async function loadTransactions() {
            if (!isApiConfigured()) {
                updateConnectionStatus(false);
                showSampleData();
                return;
            }
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTransactions&t=${Date.now()}`);
                const result = await response.json();
                if (result.success) {
                    transactions = result.data || [];
                    displayRecentTransactions();
                    updateConnectionStatus(true);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                updateConnectionStatus(false);
                showSampleData();
            }
        }

        // --- LOAN FUNCTIONS (Simplified based on script) ---
        async function handleLoanSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('loanSubmitBtn');
            setLoadingState(submitBtn, true);

            const loanData = {
                id: Date.now().toString(),
                startDate: document.getElementById('loanStartDate').value,
                type: document.getElementById('loanType').value,
                amount: parseFloat(document.getElementById('loanAmount').value),
                name: document.getElementById('loanName').value,
                note: document.getElementById('loanNote').value || '-',
                timestamp: new Date().toISOString()
            };
            
            // The script uses transaction-like columns, so we adapt the local object
            const loanForDisplay = {
                id: loanData.id,
                date: loanData.startDate,
                type: loanData.type,
                amount: loanData.amount,
                category: loanData.name, // Use name as category
                description: loanData.note, // Use note as description
                payment_method: 'loan',
                status: 'active',
                timestamp: loanData.timestamp
            };

            loans.unshift(loanForDisplay);
            displayLoans();
            updateLoanSummary();
            e.target.reset();
            document.getElementById('loanStartDate').valueAsDate = new Date();

            try {
                await apiCall('addLoan', loanData);
                showNotification('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('Error adding loan:', error);
                showNotification('‚ö†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            } finally {
                setLoadingState(submitBtn, false);
            }
        }

        async function loadLoans() {
            if (!isApiConfigured()) return;
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLoans&t=${Date.now()}`);
                const result = await response.json();
                if (result.success) {
                    loans = result.data || [];
                    displayLoans();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading loans:', error);
            }
        }

        // --- DISPLAY & RENDER FUNCTIONS ---
        function displayRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            if (transactions.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-slate-500"><div class="text-4xl mb-2">üìù</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p></div>`;
                return;
            }
            container.innerHTML = transactions.slice(0, 10).map(t => {
                const isIncome = t.type === 'income';
                const paymentIcon = { 'cash': 'üíµ', 'credit_card': 'üí≥', 'transfer': 'üè¶' };
                return `
                    <div class="transaction-item flex justify-between items-center p-5 bg-white/60 backdrop-blur-sm border border-slate-200 rounded-xl hover:bg-white/80 transition-all">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-2xl">${isIncome ? 'üí∞' : 'üí∏'}</span>
                                <span class="font-semibold text-slate-700 truncate">${t.category}</span>
                                <span class="text-lg">${paymentIcon[t.payment_method] || ''}</span>
                            </div>
                            <div class="text-sm text-slate-600 ml-10 truncate">${t.description} ‚Ä¢ ${new Date(t.date).toLocaleDateString('th-TH')}</div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <div class="text-right">
                                <div class="font-bold text-lg ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
                                    ${isIncome ? '+' : '-'}${t.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ø
                                </div>
                            </div>
                            <button class="edit-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full transition-all" data-id="${t.id}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button class="delete-btn p-2 text-red-600 hover:bg-red-100 rounded-full transition-all" data-id="${t.id}" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }).join('');
        }
        
        function displayLoans() {
            const container = document.getElementById('loanList');
            if (loans.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-slate-500"><div class="text-4xl mb-2">üí≥</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p></div>`;
                return;
            }
            container.innerHTML = loans.map(loan => `
                <div class="transaction-item bg-white/60 p-6 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-slate-700 text-lg">${loan.category}</h3>
                            <p class="text-sm text-slate-600">${loan.description}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-orange-600">${parseFloat(loan.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ø</div>
                            <div class="text-xs text-slate-500">${new Date(loan.date).toLocaleDateString('th-TH')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateLoanSummary() {
            const totalLoansCount = loans.length;
            const totalDebt = loans.reduce((sum, loan) => sum + parseFloat(loan.amount), 0);
            document.getElementById('totalLoans').textContent = totalLoansCount;
            document.getElementById('totalDebt').textContent = totalDebt.toLocaleString('th-TH', {minimumFractionDigits: 2});
            // Simplified summary as detailed data is not in the script
            document.getElementById('monthlyPayment').textContent = 'N/A';
            document.getElementById('totalInterest').textContent = 'N/A';
        }

        // --- MODAL FUNCTIONS ---
        function openEditModal(id) {
            const transaction = transactions.find(t => t.id == id);
            if (!transaction) return;
            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editType').value = transaction.type;
            document.getElementById('editAmount').value = transaction.amount;
            document.getElementById('editCategory').value = transaction.category;
            document.getElementById('editPaymentMethod').value = transaction.payment_method;
            document.getElementById('editDescription').value = transaction.description;
            document.getElementById('editDate').value = new Date(transaction.date).toISOString().split('T')[0];
            document.getElementById('editTransactionModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editTransactionModal').classList.add('hidden');
        }

        // --- CALENDAR FUNCTIONS ---
        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateCalendar();
        }

        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
            const monthlyTransactions = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            updateMonthlySummary(monthlyTransactions);
            generateCalendarGrid(year, month, monthlyTransactions);
        }

        function updateMonthlySummary(monthly) {
            const income = monthly.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthly.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('monthlyIncome').textContent = income.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('monthlyExpense').textContent = expense.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('monthlyBalance').textContent = (income - expense).toLocaleString('th-TH', {minimumFractionDigits: 2});
        }

        function generateCalendarGrid(year, month, monthly) {
            const grid = document.getElementById('calendarGrid');
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const transactionsByDate = {};
            monthly.forEach(t => {
                const date = new Date(t.date).getDate();
                if (!transactionsByDate[date]) transactionsByDate[date] = { income: 0, expense: 0 };
                if (t.type === 'income') transactionsByDate[date].income += t.amount;
                else transactionsByDate[date].expense += t.amount;
            });
            let html = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'].map(d => `<div class="p-3 text-center font-semibold text-slate-600 bg-slate-100 rounded-lg">${d}</div>`).join('');
            for (let i = 0; i < firstDay; i++) html += '<div class="p-2 h-28 bg-slate-50 rounded-lg opacity-50"></div>';
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = transactionsByDate[day];
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                html += `<div class="p-3 h-28 border-2 ${isToday ? 'bg-blue-50 border-blue-300' : 'bg-white/70 border-slate-200'} rounded-lg">
                    <div class="font-semibold text-sm mb-2 ${isToday ? 'text-blue-600' : 'text-slate-700'}">${day}</div>
                    ${dayData ? `<div class="text-xs space-y-1 overflow-hidden">
                        ${dayData.income > 0 ? `<div class="text-emerald-600 font-medium truncate">+${dayData.income.toLocaleString('th-TH')}</div>` : ''}
                        ${dayData.expense > 0 ? `<div class="text-rose-600 font-medium truncate">-${dayData.expense.toLocaleString('th-TH')}</div>` : ''}
                    </div>` : ''}
                </div>`;
            }
            grid.innerHTML = html;
        }

        // --- UTILITY FUNCTIONS ---
        function isApiConfigured() {
            return GOOGLE_SCRIPT_URL && !GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_SCRIPT_URL_HERE');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const instructions = document.getElementById('setupInstructions');
            if (connected) {
                status.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                instructions.innerHTML = '<p class="text-green-600 font-medium">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>';
            } else {
                status.className = 'w-3 h-3 bg-amber-400 rounded-full';
                instructions.querySelector('summary').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            }
        }
        
        function showSampleData() {
            transactions = [{id:"sample1", type:"income", amount:25000, category:"‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", payment_method:"transfer", description:"‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", date:new Date().toISOString().split('T')[0]}, {id:"sample2", type:"expense", amount:120, category:"‡∏≠‡∏≤‡∏´‡∏≤‡∏£", payment_method:"cash", description:"‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß", date:new Date().toISOString().split('T')[0]}];
            displayRecentTransactions();
        }

        function setLoadingState(button, isLoading) {
            const textSpan = button.querySelector('span:not([id*="loading"])');
            const loadingSpan = button.querySelector('span[id*="loading"]');
            if (isLoading) {
                button.classList.add('loading');
                textSpan.classList.add('hidden');
                loadingSpan.classList.remove('hidden');
            } else {
                button.classList.remove('loading');
                textSpan.classList.remove('hidden');
                loadingSpan.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const styles = { success: 'bg-emerald-500', error: 'bg-rose-500', warning: 'bg-amber-500', info: 'bg-blue-500' };
            notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg z-50 text-white transform transition-all duration-300 translate-x-full ${styles[type]}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function copyGoogleScript() {
            const scriptCode = document.getElementById('googleScriptCode').textContent;
            navigator.clipboard.writeText(scriptCode).then(() => {
                showNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'info');
            });
        }
    </script>
</body>
</html>
